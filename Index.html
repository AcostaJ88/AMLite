<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMMS - Sistema de Gestión de Mantenimiento</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom styles for a better look and feel */
        :root {
            --sidebar-bg: #1f2937; /* bg-gray-800 */
            --main-bg: #f3f4f6;    /* bg-gray-100 */
            --card-bg: #ffffff;
            --primary-color: #3b82f6; /* bg-blue-500 */
            --text-color: #111827; /* bg-gray-900 */
            --text-muted: #6b7280; /* bg-gray-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--main-bg);
        }
        .sidebar {
            transition: width 0.3s ease;
        }
        .sidebar-collapsed {
            width: 4.5rem;
        }
        .sidebar-expanded {
            width: 16rem;
        }
        .sidebar .nav-link span {
            transition: opacity 0.3s ease;
        }
        .sidebar-collapsed .nav-link span {
            opacity: 0;
            width: 0;
            display: none;
        }
        .sidebar-expanded .nav-link span {
            opacity: 1;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            display: none; /* Hidden by default */
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            display: none; /* Hidden by default */
            max-height: 90vh;
            overflow-y: auto;
        }
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        /* Styles for tabs */
        .tab-link {
            cursor: pointer;
            padding: 0.75rem 1.25rem;
            border-bottom: 2px solid transparent;
        }
        .tab-link.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #login-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        /* Calendar styles */
        .calendar-task {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .table-row-clickable {
            cursor: pointer;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">CMMS Pro</h2>
            <p class="text-center text-gray-500 mb-6">Inicia sesión para continuar</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700">Usuario</label>
                    <input type="text" id="username" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required value="admin">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required value="admin123">
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors">Ingresar</button>
                <p id="login-error" class="text-red-500 text-sm mt-2 text-center hidden">Usuario o contraseña incorrectos.</p>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden h-screen w-full flex">
        <!-- Notification Container -->
        <div id="notification-container" class="fixed top-5 right-5 z-[100] space-y-2"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar sidebar-expanded bg-gray-800 text-white flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
                <h1 id="sidebar-title" class="text-xl font-bold whitespace-nowrap">CMMS Pro</h1>
                <button id="toggle-sidebar-btn" class="p-2 rounded-md hover:bg-gray-700">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <nav id="main-nav" class="flex-1 p-4 space-y-2">
                <a href="#dashboard" class="nav-link flex items-center p-2 space-x-3 rounded-md hover:bg-gray-700 bg-gray-700">
                    <i class="fas fa-tachometer-alt fa-fw"></i>
                    <span class="font-semibold">Panel de Control</span>
                </a>
                <a href="#solicitudes" class="nav-link flex items-center p-2 space-x-3 rounded-md hover:bg-gray-700">
                    <i class="fas fa-clipboard-list fa-fw"></i>
                    <span class="font-semibold">Solicitudes</span>
                </a>
                <a href="#ordenes" class="nav-link flex items-center p-2 space-x-3 rounded-md hover:bg-gray-700">
                    <i class="fas fa-file-alt fa-fw"></i>
                    <span class="font-semibold">Órdenes de Trabajo</span>
                </a>
                <a href="#equipos" class="nav-link flex items-center p-2 space-x-3 rounded-md hover:bg-gray-700">
                    <i class="fas fa-cogs fa-fw"></i>
                    <span class="font-semibold">Equipos</span>
                </a>
                <a href="#preventivo" class="nav-link flex items-center p-2 space-x-3 rounded-md hover:bg-gray-700">
                    <i class="fas fa-calendar-alt fa-fw"></i>
                    <span class="font-semibold">Mantenimiento Preventivo</span>
                </a>
                <a href="#personal" class="nav-link flex items-center p-2 space-x-3 rounded-md hover:bg-gray-700">
                    <i class="fas fa-users fa-fw"></i>
                    <span class="font-semibold">Personal</span>
                </a>
                <a href="#reportes" class="nav-link flex items-center p-2 space-x-3 rounded-md hover:bg-gray-700">
                    <i class="fas fa-chart-pie fa-fw"></i>
                    <span class="font-semibold">Reportes</span>
                </a>
                <a href="#configuracion" class="nav-link flex items-center p-2 space-x-3 rounded-md hover:bg-gray-700">
                    <i class="fas fa-sliders-h fa-fw"></i>
                    <span class="font-semibold">Configuración</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center">
                <div>
                    <h2 id="page-title" class="text-2xl font-bold text-gray-800">Panel de Control</h2>
                    <p id="breadcrumb" class="text-sm text-gray-500">Inicio / Panel de Control</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" placeholder="Búsqueda global..." class="w-64 pl-10 pr-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div class="flex items-center space-x-2">
                        <img src="https://placehold.co/40x40/E2E8F0/4A5568?text=AV" alt="Avatar" class="w-10 h-10 rounded-full" id="user-avatar">
                        <div>
                            <p id="user-name" class="font-semibold text-gray-800">Admin User</p>
                            <p id="user-role" class="text-xs text-gray-500">Administrador</p>
                        </div>
                    </div>
                    <button id="logout-btn" class="text-gray-500 hover:text-red-500" title="Cerrar Sesión">
                        <i class="fas fa-sign-out-alt fa-lg"></i>
                    </button>
                </div>
            </header>

            <!-- Page Content -->
            <div id="content" class="flex-1 p-6 overflow-y-auto">
                <!-- Dashboard Section -->
                <section id="dashboard" class="page-section">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm flex items-center space-x-4">
                            <div class="bg-blue-100 text-blue-500 p-4 rounded-full"><i class="fas fa-clipboard-list fa-2x"></i></div>
                            <div>
                                <p class="text-gray-500 text-sm">Solicitudes Pendientes</p>
                                <p id="kpi-pending-req" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm flex items-center space-x-4">
                            <div class="bg-yellow-100 text-yellow-500 p-4 rounded-full"><i class="fas fa-file-alt fa-2x"></i></div>
                            <div>
                                <p class="text-gray-500 text-sm">Órdenes en Progreso</p>
                                <p id="kpi-progress-wo" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-sm flex items-center space-x-4">
                            <div class="bg-green-100 text-green-500 p-4 rounded-full"><i class="fas fa-check-circle fa-2x"></i></div>
                            <div>
                                <p class="text-gray-500 text-sm">Órdenes Completadas (Mes)</p>
                                <p id="kpi-completed-wo" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow-sm flex items-center space-x-4">
                            <div class="bg-red-100 text-red-500 p-4 rounded-full"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
                            <div>
                                <p class="text-gray-500 text-sm">Equipos Fuera de Servicio</p>
                                <p id="kpi-down-equip" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-4">Órdenes de Trabajo por Mes</h3>
                            <canvas id="woChart"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-4">Estado de Equipos</h3>
                            <canvas id="equipmentStatusChart"></canvas>
                        </div>
                    </div>

                    <!-- Lists -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-4">Próximos Mantenimientos Preventivos</h3>
                            <div id="upcoming-pm-list" class="space-y-3"></div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-4">Últimas Solicitudes Recibidas</h3>
                            <div id="latest-req-list" class="space-y-3"></div>
                        </div>
                    </div>
                </section>

                <!-- Solicitudes Section -->
                <section id="solicitudes" class="page-section hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Gestión de Solicitudes</h3>
                            <button id="add-solicitud-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>Nueva Solicitud</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3">Descripción</th>
                                        <th class="p-3">Equipo</th>
                                        <th class="p-3">Solicitante</th>
                                        <th class="p-3">Fecha</th>
                                        <th class="p-3">Estado</th>
                                        <th class="p-3">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="solicitud-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Equipos Section -->
                <section id="equipos" class="page-section hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Gestión de Equipos</h3>
                            <button id="add-equipo-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>Nuevo Equipo</span>
                            </button>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="search-equipo" placeholder="Buscar equipo por nombre, modelo o ubicación..." class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3">Nombre</th>
                                        <th class="p-3">Categoría</th>
                                        <th class="p-3">Ubicación</th>
                                        <th class="p-3">Estado</th>
                                        <th class="p-3">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="equipo-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Órdenes de Trabajo Section -->
                <section id="ordenes" class="page-section hidden">
                     <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Órdenes de Trabajo</h3>
                            <button id="add-orden-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>Nueva Orden</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input type="text" id="search-orden" placeholder="Buscar por descripción..." class="p-2 border rounded-lg">
                            <select id="filter-orden-status" class="p-2 border rounded-lg"><option value="">Todos los Estados</option><option>Pendiente</option><option>En Progreso</option><option>Completada</option><option>Cancelada</option></select>
                            <select id="filter-orden-priority" class="p-2 border rounded-lg"><option value="">Todas las Prioridades</option><option>Baja</option><option>Media</option><option>Alta</option><option>Crítica</option></select>
                             <input type="date" id="filter-orden-date" class="p-2 border rounded-lg">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3">ID</th><th class="p-3">Descripción</th><th class="p-3">Equipo</th><th class="p-3">Técnico</th><th class="p-3">Prioridad</th><th class="p-3">Estado</th><th class="p-3">Fecha Creación</th><th class="p-3">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="orden-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Mantenimiento Preventivo Section -->
                <section id="preventivo" class="page-section hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Calendario de Mantenimiento</h3>
                            <button id="add-preventivo-rutina-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>Nueva Rutina</span>
                            </button>
                        </div>
                        <div id="calendar-header" class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-md hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                            <h2 id="month-year-header" class="text-lg font-semibold"></h2>
                            <button id="next-month-btn" class="p-2 rounded-md hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-600 mb-2">
                            <div>Dom</div><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                            <!-- Calendar days will be generated by JS -->
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm mt-6">
                        <h3 class="text-xl font-bold mb-4">Rutinas de Mantenimiento Programadas</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3">Tarea</th><th class="p-3">Equipo</th><th class="p-3">Frecuencia</th><th class="p-3">Próxima Fecha</th><th class="p-3">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="preventivo-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Personal Section -->
                <section id="personal" class="page-section hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Gestión de Personal</h3>
                            <button id="add-tecnico-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center space-x-2">
                                <i class="fas fa-plus"></i>
                                <span>Nuevo Técnico</span>
                            </button>
                        </div>
                         <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3">Nombre</th><th class="p-3">Email</th><th class="p-3">Especialidad</th><th class="p-3">Órdenes Asignadas</th><th class="p-3">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="personal-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Reportes Section -->
                <section id="reportes" class="page-section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-4">Generador de Reportes</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tipo de Reporte</label>
                                    <select id="report-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                        <option value="historial-equipo">Historial de Mantenimiento por Equipo</option>
                                        <option value="productividad-tecnico">Productividad de Técnicos</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Rango de Fechas</label>
                                    <div class="flex space-x-2 mt-1">
                                        <input type="date" id="report-date-start" class="block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                        <input type="date" id="report-date-end" class="block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    </div>
                                </div>
                                <button id="generate-report-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center space-x-2">
                                    <i class="fas fa-cogs"></i>
                                    <span>Generar Reporte</span>
                                </button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-4">Órdenes de Trabajo por Prioridad</h3>
                            <canvas id="woPriorityChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Configuración Section -->
                <section id="configuracion" class="page-section hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold mb-4">Configuración del Sistema</h3>
                        <div class="border-b border-gray-200">
                            <nav class="flex space-x-4" id="config-tabs">
                                <a class="tab-link active" data-tab="usuarios">Usuarios</a>
                                <a class="tab-link" data-tab="ubicaciones">Ubicaciones</a>
                                <a class="tab-link" data-tab="categorias">Categorías de Equipos</a>
                            </nav>
                        </div>
                        <div class="mt-6">
                            <div id="tab-usuarios" class="tab-content active">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-lg font-semibold">Gestión de Usuarios</h4>
                                    <button id="add-usuario-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center space-x-2">
                                        <i class="fas fa-plus"></i>
                                        <span>Nuevo Usuario</span>
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead class="bg-gray-50">
                                            <tr><th class="p-3">Usuario</th><th class="p-3">Email</th><th class="p-3">Rol</th><th class="p-3">Acciones</th></tr>
                                        </thead>
                                        <tbody id="usuarios-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="tab-ubicaciones" class="tab-content">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-lg font-semibold">Gestión de Ubicaciones</h4>
                                    <button id="add-ubicacion-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center space-x-2">
                                        <i class="fas fa-plus"></i>
                                        <span>Nueva Ubicación</span>
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead class="bg-gray-50">
                                            <tr><th class="p-3">Nombre de la Ubicación</th><th class="p-3">Acciones</th></tr>
                                        </thead>
                                        <tbody id="ubicaciones-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="tab-categorias" class="tab-content">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-lg font-semibold">Gestión de Categorías de Equipos</h4>
                                    <button id="add-categoria-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center space-x-2">
                                        <i class="fas fa-plus"></i>
                                        <span>Nueva Categoría</span>
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead class="bg-gray-50">
                                            <tr><th class="p-3">Nombre de la Categoría</th><th class="p-3">Acciones</th></tr>
                                        </thead>
                                        <tbody id="categorias-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="modal-backdrop"></div>

    <!-- Modals -->
    <div id="equipo-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2">
        <div class="p-6 border-b"><h3 id="equipo-modal-title" class="text-2xl font-bold">Nuevo Equipo</h3></div>
        <form id="equipo-form" class="p-6 space-y-4">
            <input type="hidden" id="equipo-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="equipo-nombre" class="block text-sm font-medium text-gray-700">Nombre del Equipo</label><input type="text" id="equipo-nombre" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
                <div><label for="equipo-categoria" class="block text-sm font-medium text-gray-700">Categoría</label><select id="equipo-categoria" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></select></div>
                <div><label for="equipo-ubicacion" class="block text-sm font-medium text-gray-700">Ubicación</label><select id="equipo-ubicacion" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></select></div>
                <div><label for="equipo-modelo" class="block text-sm font-medium text-gray-700">Modelo</label><input type="text" id="equipo-modelo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="equipo-serie" class="block text-sm font-medium text-gray-700">Número de Serie</label><input type="text" id="equipo-serie" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="equipo-estado" class="block text-sm font-medium text-gray-700">Estado</label><select id="equipo-estado" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required><option>Operativo</option><option>En Mantenimiento</option><option>Fuera de Servicio</option></select></div>
            </div>
            <div><label for="equipo-specs" class="block text-sm font-medium text-gray-700">Especificaciones Técnicas</label><textarea id="equipo-specs" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea></div>
            <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancel-equipo-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Guardar Equipo</button></div>
        </form>
    </div>
    <div id="orden-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2">
        <div class="p-6 border-b"><h3 id="orden-modal-title" class="text-2xl font-bold">Nueva Orden de Trabajo</h3></div>
        <form id="orden-form" class="p-6 space-y-4">
            <input type="hidden" id="orden-id"><input type="hidden" id="orden-source-solicitud-id">
            <div><label for="orden-descripcion" class="block text-sm font-medium text-gray-700">Descripción del Trabajo</label><input type="text" id="orden-descripcion" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="orden-equipo" class="block text-sm font-medium text-gray-700">Equipo</label><select id="orden-equipo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></select></div>
                <div><label for="orden-tecnico" class="block text-sm font-medium text-gray-700">Técnico Asignado</label><select id="orden-tecnico" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></select></div>
                <div><label for="orden-prioridad" class="block text-sm font-medium text-gray-700">Prioridad</label><select id="orden-prioridad" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required><option>Baja</option><option>Media</option><option>Alta</option><option>Crítica</option></select></div>
                <div><label for="orden-estado" class="block text-sm font-medium text-gray-700">Estado</label><select id="orden-estado" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required><option>Pendiente</option><option>En Progreso</option><option>Completada</option><option>Cancelada</option></select></div>
            </div>
            <div><label for="orden-detalles" class="block text-sm font-medium text-gray-700">Detalles del Trabajo Realizado</label><textarea id="orden-detalles" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea></div>
            <div class="flex items-center space-x-2"><input type="checkbox" id="orden-add-preventivo" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="orden-add-preventivo" class="text-sm font-medium text-gray-700">Agregar a plan preventivo</label></div>
            <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancel-orden-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Guardar Orden</button></div>
        </form>
    </div>
    <div id="tecnico-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-6 border-b"><h3 id="tecnico-modal-title" class="text-2xl font-bold">Nuevo Técnico</h3></div>
        <form id="tecnico-form" class="p-6 space-y-4">
            <input type="hidden" id="tecnico-id">
            <div><label for="tecnico-nombre" class="block text-sm font-medium text-gray-700">Nombre Completo</label><input type="text" id="tecnico-nombre" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
            <div><label for="tecnico-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="tecnico-email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
            <div><label for="tecnico-especialidad" class="block text-sm font-medium text-gray-700">Especialidad</label><select id="tecnico-especialidad" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required><option>Mecánico</option><option>Eléctrico</option><option>Instrumentista</option><option>General</option></select></div>
            <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancel-tecnico-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Guardar Técnico</button></div>
        </form>
    </div>
    <div id="solicitud-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-6 border-b"><h3 id="solicitud-modal-title" class="text-2xl font-bold">Nueva Solicitud</h3></div>
        <form id="solicitud-form" class="p-6 space-y-4">
            <div><label for="solicitud-descripcion" class="block text-sm font-medium text-gray-700">Descripción del Problema</label><textarea id="solicitud-descripcion" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></textarea></div>
            <div><label for="solicitud-equipo" class="block text-sm font-medium text-gray-700">Equipo Afectado</label><select id="solicitud-equipo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></select></div>
            <div><label for="solicitud-solicitante" class="block text-sm font-medium text-gray-700">Su Nombre (Solicitante)</label><input type="text" id="solicitud-solicitante" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
            <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancel-solicitud-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Enviar Solicitud</button></div>
        </form>
    </div>
    
    <!-- Usuario Modal -->
    <div id="usuario-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-6 border-b"><h3 id="usuario-modal-title" class="text-2xl font-bold">Nuevo Usuario</h3></div>
        <form id="usuario-form" class="p-6 space-y-4">
            <input type="hidden" id="usuario-id">
            <div><label for="usuario-username" class="block text-sm font-medium text-gray-700">Nombre de Usuario</label><input type="text" id="usuario-username" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
            <div><label for="usuario-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="usuario-email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
            <div><label for="usuario-password" class="block text-sm font-medium text-gray-700">Contraseña</label><input type="password" id="usuario-password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="Dejar en blanco para no cambiar"></div>
            <div><label for="usuario-role" class="block text-sm font-medium text-gray-700">Rol</label><select id="usuario-role" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required><option>Administrador</option><option>Planificador</option><option>Supervisor</option><option>Cliente</option></select></div>
            <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancel-usuario-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Guardar Usuario</button></div>
        </form>
    </div>

    <!-- Categoria Modal -->
    <div id="categoria-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-6 border-b"><h3 id="categoria-modal-title" class="text-2xl font-bold">Nueva Categoría</h3></div>
        <form id="categoria-form" class="p-6 space-y-4">
            <input type="hidden" id="categoria-id">
            <div><label for="categoria-nombre" class="block text-sm font-medium text-gray-700">Nombre de la Categoría</label><input type="text" id="categoria-nombre" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
            <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancel-categoria-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Guardar Categoría</button></div>
        </form>
    </div>
    
    <!-- Ubicacion Modal -->
    <div id="ubicacion-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-6 border-b"><h3 id="ubicacion-modal-title" class="text-2xl font-bold">Nueva Ubicación</h3></div>
        <form id="ubicacion-form" class="p-6 space-y-4">
            <input type="hidden" id="ubicacion-id">
            <div><label for="ubicacion-nombre" class="block text-sm font-medium text-gray-700">Nombre de la Ubicación</label><input type="text" id="ubicacion-nombre" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
            <div><label for="ubicacion-padre" class="block text-sm font-medium text-gray-700">Ubicación Padre (Opcional)</label><select id="ubicacion-padre" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select></div>
            <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancel-ubicacion-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Guardar Ubicación</button></div>
        </form>
    </div>

    <!-- Preventivo Day Modal -->
    <div id="preventivo-day-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 id="preventivo-day-modal-title" class="text-2xl font-bold">Tareas del Día</h3>
            <button id="close-preventivo-day-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
        </div>
        <div id="preventivo-day-modal-body" class="p-6 space-y-3">
            <!-- Daily tasks will be listed here -->
        </div>
    </div>
    
    <!-- Preventivo Rutina Modal -->
    <div id="preventivo-rutina-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-2/5">
        <div class="p-6 border-b"><h3 id="preventivo-rutina-modal-title" class="text-2xl font-bold">Nueva Rutina Preventiva</h3></div>
        <form id="preventivo-rutina-form" class="p-6 space-y-4">
            <input type="hidden" id="preventivo-rutina-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="preventivo-rutina-tarea" class="block text-sm font-medium text-gray-700">Título de la Rutina</label><input type="text" id="preventivo-rutina-tarea" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
                <div><label for="preventivo-rutina-equipo" class="block text-sm font-medium text-gray-700">Equipo</label><select id="preventivo-rutina-equipo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></select></div>
                <div><label for="preventivo-rutina-frecuencia" class="block text-sm font-medium text-gray-700">Frecuencia</label><select id="preventivo-rutina-frecuencia" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required><option>Diaria</option><option>Semanal</option><option>Quincenal</option><option>Mensual</option><option>Trimestral</option><option>Semestral</option><option>Anual</option></select></div>
                <div><label for="preventivo-rutina-fecha" class="block text-sm font-medium text-gray-700">Próxima Fecha</label><input type="date" id="preventivo-rutina-fecha" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></div>
            </div>
            <div><label for="preventivo-rutina-estado" class="block text-sm font-medium text-gray-700">Estado</label><select id="preventivo-rutina-estado" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required><option>Programado</option><option>Completado</option><option>Vencido</option></select></div>
            
            <hr class="my-4">
            <h4 class="text-lg font-semibold">Tareas a Realizar</h4>
            <div id="preventivo-rutina-tasks-list" class="space-y-2 max-h-40 overflow-y-auto p-2 border rounded-md"></div>
            <div class="flex items-center space-x-2">
                <input type="text" id="new-task-description" placeholder="Nueva tarea..." class="block w-full border border-gray-300 rounded-md shadow-sm p-2">
                <button type="button" id="add-task-btn" class="bg-gray-200 px-3 py-2 rounded-lg hover:bg-gray-300">Añadir</button>
            </div>
            <button type="button" id="import-ot-btn" class="w-full text-sm bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200 flex items-center justify-center space-x-2">
                <i class="fas fa-file-import"></i>
                <span>Importar desde OT</span>
            </button>

            <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancel-preventivo-rutina-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Guardar Rutina</button></div>
        </form>
    </div>

    <!-- Import OT Modal -->
    <div id="import-ot-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-6 border-b"><h3 class="text-2xl font-bold">Importar Tarea desde OT</h3></div>
        <div class="p-6 space-y-4">
            <label for="import-ot-select" class="block text-sm font-medium text-gray-700">Seleccionar Orden de Trabajo</label>
            <select id="import-ot-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="cancel-import-ot-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="button" id="confirm-import-ot-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Importar Tarea</button>
            </div>
        </div>
    </div>

    <!-- Report Preview Modal -->
    <div id="report-preview-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 id="report-preview-title" class="text-2xl font-bold">Vista Previa de Reporte</h3>
            <button id="close-report-preview-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
        </div>
        <div class="p-6">
            <div id="report-preview-table-container" class="max-h-96 overflow-y-auto border rounded-lg"></div>
        </div>
        <div class="p-6 border-t flex justify-end space-x-3">
            <button id="export-csv-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center space-x-2"><i class="fas fa-file-csv"></i><span>Exportar a CSV</span></button>
            <button id="export-html-btn" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 flex items-center space-x-2"><i class="fab fa-html5"></i><span>Exportar a HTML</span></button>
            <button id="export-excel-btn" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 flex items-center space-x-2"><i class="fas fa-file-excel"></i><span>Exportar a Excel</span></button>
        </div>
    </div>

    <!-- Select Equipo Report Modal -->
    <div id="select-equipo-report-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
        <div class="p-6 border-b"><h3 class="text-2xl font-bold">Seleccionar Equipo</h3></div>
        <div class="p-6 space-y-4">
            <label for="select-equipo-report-select" class="block text-sm font-medium text-gray-700">Equipo para el reporte</label>
            <select id="select-equipo-report-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="cancel-select-equipo-report-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="button" id="confirm-select-equipo-report-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Generar</button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DATA SIMULATION ---
    const getInitialData = (key, defaultData) => {
        const storedData = localStorage.getItem(key);
        return storedData ? JSON.parse(storedData) : defaultData;
    };
    const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));

    // Initial Data
    let users = getInitialData('cmms_users', [
        { id: 1, username: 'admin', email: 'admin@cmms.com', password: 'admin123', role: 'Administrador' },
        { id: 2, username: 'planificador', email: 'planner@cmms.com', password: 'plan123', role: 'Planificador' },
        { id: 3, username: 'supervisor', email: 'sup@cmms.com', password: 'super123', role: 'Supervisor' },
        { id: 4, username: 'cliente', email: 'client@cmms.com', password: 'cliente123', role: 'Cliente' },
    ]);
    let categorias = getInitialData('cmms_categorias', [
        { id: 1, nombre: 'Bomba Centrífuga' },
        { id: 2, nombre: 'Compresor de Aire' },
        { id: 3, nombre: 'Motor Eléctrico' },
        { id: 4, nombre: 'Transformador' },
    ]);
    let ubicaciones = getInitialData('cmms_ubicaciones', [
        { id: 1, nombre: 'Planta 1', parentId: null },
        { id: 2, nombre: 'Área de Extrusión', parentId: 1 },
        { id: 3, nombre: 'Cabezal A', parentId: 2 },
        { id: 4, nombre: 'Sala de Compresores', parentId: 1 },
    ]);
    let equipos = getInitialData('cmms_equipos', [
        { id: 1, nombre: 'Bomba Centrífuga P-101', categoria: 'Bomba Centrífuga', ubicacionId: 3, modelo: 'BC-5000', serie: 'SN-112233', estado: 'Operativo', specs: 'Motor 50HP, Caudal 100m3/h' },
        { id: 2, nombre: 'Compresor de Aire C-201', categoria: 'Compresor de Aire', ubicacionId: 4, modelo: 'AIR-MAX-200', serie: 'SN-445566', estado: 'Operativo', specs: 'Presión 10 bar, 200 CFM' },
        { id: 3, nombre: 'Motor Eléctrico M-301', categoria: 'Motor Eléctrico', ubicacionId: 2, modelo: 'WEG-3P', serie: 'SN-778899', estado: 'En Mantenimiento', specs: '15HP, 1750 RPM' },
    ]);
    let tecnicos = getInitialData('cmms_tecnicos', [
        { id: 1, nombre: 'Juan Pérez', email: 'juan.perez@example.com', especialidad: 'Mecánico' },
        { id: 2, nombre: 'María García', email: 'maria.garcia@example.com', especialidad: 'Eléctrico' },
    ]);
    let ordenes = getInitialData('cmms_ordenes', [
        { id: 1, descripcion: 'Fuga en sello mecánico', equipoId: 1, tecnicoId: 1, prioridad: 'Alta', estado: 'Completada', fechaCreacion: '2024-07-10', detalles: 'Se reemplazó el sello mecánico.' },
        { id: 2, descripcion: 'Revisión de contactores', equipoId: 3, tecnicoId: 2, prioridad: 'Media', estado: 'En Progreso', fechaCreacion: '2024-07-15', detalles: '' },
    ]);
    let preventivos = getInitialData('cmms_preventivos', [
        { id: 1, tarea: 'Inspección y Limpieza de Filtros', equipoId: 2, frecuencia: 'Mensual', proximaFecha: '2025-08-01', status: 'Programado', tasks: [{id: Date.now(), description: 'Verificar presión de aire', source: 'Manual'}] },
        { id: 2, tarea: 'Análisis de Vibraciones', equipoId: 1, frecuencia: 'Trimestral', proximaFecha: '2025-09-15', status: 'Programado', tasks: [] },
    ]);
    let scheduledPreventivos = getInitialData('cmms_scheduled_preventivos', [
        { id: 1, tarea: 'Inspección de Filtros', equipoId: 2, fecha: '2025-08-05' },
        { id: 2, tarea: 'Análisis de Vibraciones', equipoId: 1, fecha: '2025-08-15' },
        { id: 3, tarea: 'Reapriete de Conexiones', equipoId: 3, fecha: '2025-08-15' },
        { id: 4, tarea: 'Limpieza General', equipoId: 2, fecha: '2025-09-01' },
    ]);
    let solicitudes = getInitialData('cmms_solicitudes', [
        { id: 1, descripcion: 'Ruido extraño en el motor de la línea de empaque', equipoId: 3, solicitante: 'Operador de Línea 1', fecha: '2024-07-21', estado: 'Pendiente' },
        { id: 2, descripcion: 'Baja presión en el compresor C-201', equipoId: 2, solicitante: 'Supervisor de Planta', fecha: '2024-07-20', estado: 'Aprobada' },
    ]);
    
    let currentUser = null;
    let currentDisplayDate = new Date();
    let tempPreventivoTasks = [];
    let currentReportData = { headers: [], rows: [] };

    // --- UI ELEMENTS ---
    const loginScreen = document.getElementById('login-screen');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const mainNav = document.getElementById('main-nav');
    const addUsuarioBtn = document.getElementById('add-usuario-btn');
    const usuarioModal = document.getElementById('usuario-modal');
    const usuarioForm = document.getElementById('usuario-form');
    const cancelUsuarioModalBtn = document.getElementById('cancel-usuario-modal');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const equipoModal = document.getElementById('equipo-modal');
    const ordenModal = document.getElementById('orden-modal');
    const tecnicoModal = document.getElementById('tecnico-modal');
    const solicitudModal = document.getElementById('solicitud-modal');
    const categoriaModal = document.getElementById('categoria-modal');
    const ubicacionModal = document.getElementById('ubicacion-modal');
    const preventivoDayModal = document.getElementById('preventivo-day-modal');
    const preventivoRutinaModal = document.getElementById('preventivo-rutina-modal');
    const importOtModal = document.getElementById('import-ot-modal');
    const reportPreviewModal = document.getElementById('report-preview-modal');
    const selectEquipoReportModal = document.getElementById('select-equipo-report-modal');
    const addEquipoBtn = document.getElementById('add-equipo-btn');
    const addOrdenBtn = document.getElementById('add-orden-btn');
    const addTecnicoBtn = document.getElementById('add-tecnico-btn');
    const addSolicitudBtn = document.getElementById('add-solicitud-btn');
    const addCategoriaBtn = document.getElementById('add-categoria-btn');
    const addUbicacionBtn = document.getElementById('add-ubicacion-btn');
    const addPreventivoRutinaBtn = document.getElementById('add-preventivo-rutina-btn');
    const equipoForm = document.getElementById('equipo-form');
    const ordenForm = document.getElementById('orden-form');
    const tecnicoForm = document.getElementById('tecnico-form');
    const solicitudForm = document.getElementById('solicitud-form');
    const categoriaForm = document.getElementById('categoria-form');
    const ubicacionForm = document.getElementById('ubicacion-form');
    const preventivoRutinaForm = document.getElementById('preventivo-rutina-form');
    const cancelEquipoModalBtn = document.getElementById('cancel-equipo-modal');
    const cancelOrdenModalBtn = document.getElementById('cancel-orden-modal');
    const cancelTecnicoModalBtn = document.getElementById('cancel-tecnico-modal');
    const cancelSolicitudModalBtn = document.getElementById('cancel-solicitud-modal');
    const cancelCategoriaModalBtn = document.getElementById('cancel-categoria-modal');
    const cancelUbicacionModalBtn = document.getElementById('cancel-ubicacion-modal');
    const cancelPreventivoRutinaModalBtn = document.getElementById('cancel-preventivo-rutina-modal');
    const closePreventivoDayModalBtn = document.getElementById('close-preventivo-day-modal');
    const navLinks = document.querySelectorAll('.nav-link');
    const pageSections = document.querySelectorAll('.page-section');
    const pageTitle = document.getElementById('page-title');
    const breadcrumb = document.getElementById('breadcrumb');


    // --- AUTHENTICATION LOGIC ---
    const handleLogin = (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const user = users.find(u => u.username === username && u.password === password);

        if (user) {
            currentUser = user;
            sessionStorage.setItem('cmms_currentUser', JSON.stringify(user));
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            initializeApp();
        } else {
            document.getElementById('login-error').classList.remove('hidden');
        }
    };

    const handleLogout = () => {
        currentUser = null;
        sessionStorage.removeItem('cmms_currentUser');
        appContainer.classList.add('hidden');
        loginScreen.classList.remove('hidden');
        location.reload(); // Simple way to reset state
    };

    const checkSession = () => {
        const userJson = sessionStorage.getItem('cmms_currentUser');
        if (userJson) {
            currentUser = JSON.parse(userJson);
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            initializeApp();
        }
    };

    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', handleLogout);

    // --- PERMISSIONS LOGIC ---
    const applyPermissions = () => {
        if (!currentUser) return;
        
        const userRole = currentUser.role;
        const permissions = {
            'Cliente': ['dashboard', 'solicitudes'],
            'Supervisor': ['dashboard', 'solicitudes', 'ordenes', 'equipos', 'personal'],
            'Planificador': ['dashboard', 'solicitudes', 'ordenes', 'equipos', 'preventivo', 'personal', 'reportes'],
            'Administrador': ['dashboard', 'solicitudes', 'ordenes', 'equipos', 'preventivo', 'personal', 'reportes', 'configuracion']
        };

        const allowedModules = permissions[userRole] || [];
        
        mainNav.querySelectorAll('.nav-link').forEach(link => {
            const module = link.getAttribute('href').substring(1);
            link.style.display = allowedModules.includes(module) ? 'flex' : 'none';
        });
        
        document.getElementById('user-name').textContent = currentUser.username;
        document.getElementById('user-role').textContent = currentUser.role;
        document.getElementById('user-avatar').src = `https://placehold.co/40x40/E2E8F0/4A5568?text=${currentUser.username.substring(0,2).toUpperCase()}`;

        document.getElementById('add-equipo-btn').style.display = ['Administrador', 'Supervisor'].includes(userRole) ? 'flex' : 'none';
        document.getElementById('add-orden-btn').style.display = ['Administrador', 'Supervisor', 'Planificador'].includes(userRole) ? 'flex' : 'none';
        document.getElementById('add-tecnico-btn').style.display = ['Administrador', 'Supervisor'].includes(userRole) ? 'flex' : 'none';
    };

    // --- CORE APP LOGIC ---
    const showNotification = (message, type = 'info') => {
        const container = document.getElementById('notification-container');
        const colors = { info: 'bg-blue-500', error: 'bg-red-500', success: 'bg-green-500' };
        const notification = document.createElement('div');
        notification.className = `text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full max-w-sm ${colors[type]}`;
        notification.textContent = message;
        container.appendChild(notification);
        setTimeout(() => notification.classList.remove('translate-x-full'), 10);
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    };

    const openModal = (modal) => {
        modalBackdrop.style.display = 'block';
        modal.style.display = 'block';
    };

    const closeModal = (modal) => {
        modalBackdrop.style.display = 'none';
        modal.style.display = 'none';
    };
    
    modalBackdrop.addEventListener('click', () => [equipoModal, ordenModal, tecnicoModal, solicitudModal, usuarioModal, categoriaModal, ubicacionModal, preventivoDayModal, preventivoRutinaModal, importOtModal, reportPreviewModal, selectEquipoReportModal].forEach(closeModal));
    cancelEquipoModalBtn.addEventListener('click', () => closeModal(equipoModal));
    cancelOrdenModalBtn.addEventListener('click', () => closeModal(ordenModal));
    cancelTecnicoModalBtn.addEventListener('click', () => closeModal(tecnicoModal));
    cancelSolicitudModalBtn.addEventListener('click', () => closeModal(solicitudModal));
    cancelUsuarioModalBtn.addEventListener('click', () => closeModal(usuarioModal));
    cancelCategoriaModalBtn.addEventListener('click', () => closeModal(categoriaModal));
    cancelUbicacionModalBtn.addEventListener('click', () => closeModal(ubicacionModal));
    closePreventivoDayModalBtn.addEventListener('click', () => closeModal(preventivoDayModal));
    cancelPreventivoRutinaModalBtn.addEventListener('click', () => closeModal(preventivoRutinaModal));
    document.getElementById('cancel-import-ot-modal').addEventListener('click', () => closeModal(importOtModal));
    document.getElementById('close-report-preview-modal').addEventListener('click', () => closeModal(reportPreviewModal));
    document.getElementById('cancel-select-equipo-report-modal').addEventListener('click', () => closeModal(selectEquipoReportModal));

    // --- NAVIGATION LOGIC ---
    const navigateTo = (hash) => {
        const targetId = hash.substring(1);
        const targetSection = document.getElementById(targetId);
        pageSections.forEach(section => section.classList.add('hidden'));
        (targetSection || document.getElementById('dashboard')).classList.remove('hidden');
        navLinks.forEach(link => {
            link.classList.toggle('bg-gray-700', link.getAttribute('href') === hash);
            if (link.getAttribute('href') === hash) {
                const linkText = link.querySelector('span').textContent;
                pageTitle.textContent = linkText;
                breadcrumb.textContent = `Inicio / ${linkText}`;
            }
        });
    };

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const hash = e.currentTarget.getAttribute('href');
            window.location.hash = hash;
        });
    });

    window.addEventListener('hashchange', () => navigateTo(window.location.hash));

    // --- DASHBOARD LOGIC ---
    const setupDashboard = () => {
        document.getElementById('kpi-pending-req').textContent = solicitudes.filter(s => s.estado === 'Pendiente').length;
        document.getElementById('kpi-progress-wo').textContent = ordenes.filter(o => o.estado === 'En Progreso').length;
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
        document.getElementById('kpi-completed-wo').textContent = ordenes.filter(o => o.estado === 'Completada' && new Date(o.fechaCreacion) > oneMonthAgo).length;
        document.getElementById('kpi-down-equip').textContent = equipos.filter(e => e.estado === 'Fuera de Servicio').length;

        const latestReqList = document.getElementById('latest-req-list');
        latestReqList.innerHTML = '';
        solicitudes.slice(0, 3).forEach(s => {
            const equipo = equipos.find(e => e.id === s.equipoId);
            latestReqList.innerHTML += `<div class="flex justify-between items-center p-2 rounded hover:bg-gray-50"><div><p class="font-semibold">${s.descripcion}</p><p class="text-sm text-gray-500">${equipo ? equipo.nombre : ''} - por ${s.solicitante}</p></div><span class="text-xs font-medium text-gray-500">${s.fecha}</span></div>`;
        });
        
        const upcomingPmList = document.getElementById('upcoming-pm-list');
        upcomingPmList.innerHTML = '';
        preventivos.slice(0,2).forEach(p => {
             const equipo = equipos.find(e => e.id === p.equipoId);
             upcomingPmList.innerHTML += `<div class="flex justify-between items-center p-2 rounded hover:bg-gray-50"><div><p class="font-semibold">${equipo.nombre}</p><p class="text-sm text-gray-500">${p.tarea}</p></div><p class="text-sm font-medium text-yellow-600">${p.proximaFecha}</p></div>`;
        });

        const woChartCtx = document.getElementById('woChart').getContext('2d');
        new Chart(woChartCtx, { type: 'bar', data: { labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul'], datasets: [{ label: 'Completadas', data: [12, 19, 15, 25, 22, 18, 20], backgroundColor: 'rgba(59, 130, 246, 0.5)' }, { label: 'Pendientes', data: [5, 8, 4, 7, 6, 9, 5], backgroundColor: 'rgba(239, 68, 68, 0.5)' }] }, options: { responsive: true } });
        const equipmentStatusCtx = document.getElementById('equipmentStatusChart').getContext('2d');
        const statusCounts = equipos.reduce((acc, eq) => { acc[eq.estado] = (acc[eq.estado] || 0) + 1; return acc; }, {});
        new Chart(equipmentStatusCtx, { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(234, 179, 8, 0.7)', 'rgba(239, 68, 68, 0.7)'] }] }, options: { responsive: true } });
    };
    
    // --- SOLICITUDES LOGIC ---
    const getSolicitudStatusBadge = (status) => {
        const colors = { 'Pendiente': 'bg-yellow-100 text-yellow-800', 'Aprobada': 'bg-green-100 text-green-800', 'Rechazada': 'bg-red-100 text-red-800' };
        return `<span class="priority-badge ${colors[status]}">${status}</span>`;
    };

    const renderSolicitudes = () => {
        const tableBody = document.getElementById('solicitud-table-body');
        tableBody.innerHTML = '';
        solicitudes.forEach(s => {
            const equipo = equipos.find(e => e.id === s.equipoId) || { nombre: 'N/A' };
            let actions = '';
            if (currentUser.role !== 'Cliente' && s.estado === 'Pendiente') {
                actions = `
                    <button class="text-green-500 hover:text-green-700 mr-2" title="Convertir a OT" onclick="convertirSolicitud(${s.id})"><i class="fas fa-check-circle"></i></button>
                    <button class="text-red-500 hover:text-red-700" title="Rechazar" onclick="rechazarSolicitud(${s.id})"><i class="fas fa-times-circle"></i></button>
                `;
            }
            tableBody.innerHTML += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium">${s.descripcion}</td>
                    <td class="p-3 text-gray-600">${equipo.nombre}</td>
                    <td class="p-3 text-gray-600">${s.solicitante}</td>
                    <td class="p-3 text-gray-600">${s.fecha}</td>
                    <td class="p-3">${getSolicitudStatusBadge(s.estado)}</td>
                    <td class="p-3">${actions}</td>
                </tr>
            `;
        });
    };

    const populateSolicitudModalDropdowns = () => {
        document.getElementById('solicitud-equipo').innerHTML = equipos.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
    };

    addSolicitudBtn.addEventListener('click', () => {
        solicitudForm.reset();
        populateSolicitudModalDropdowns();
        openModal(solicitudModal);
    });

    solicitudForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const nuevaSolicitud = {
            id: Date.now(),
            descripcion: document.getElementById('solicitud-descripcion').value,
            equipoId: parseInt(document.getElementById('solicitud-equipo').value),
            solicitante: document.getElementById('solicitud-solicitante').value,
            fecha: new Date().toISOString().split('T')[0],
            estado: 'Pendiente'
        };
        solicitudes.unshift(nuevaSolicitud);
        saveData('cmms_solicitudes', solicitudes);
        renderSolicitudes();
        setupDashboard();
        closeModal(solicitudModal);
        showNotification('Solicitud enviada con éxito.', 'success');
    });

    window.convertirSolicitud = (id) => {
        const solicitud = solicitudes.find(s => s.id === id);
        if (solicitud) {
            ordenForm.reset();
            document.getElementById('orden-id').value = '';
            document.getElementById('orden-source-solicitud-id').value = id;
            document.getElementById('orden-modal-title').textContent = 'Nueva Orden de Trabajo (desde Solicitud)';
            populateOrdenModalDropdowns();
            document.getElementById('orden-descripcion').value = solicitud.descripcion;
            document.getElementById('orden-equipo').value = solicitud.equipoId;
            openModal(ordenModal);
        }
    };

    window.rechazarSolicitud = (id) => {
        if (confirm('¿Está seguro de que desea rechazar esta solicitud?')) {
            const index = solicitudes.findIndex(s => s.id === id);
            if (index !== -1) {
                solicitudes[index].estado = 'Rechazada';
                saveData('cmms_solicitudes', solicitudes);
                renderSolicitudes();
                setupDashboard();
            }
        }
    };

    // --- EQUIPOS LOGIC ---
    const getLocationPath = (locationId) => {
        let path = [];
        let current = ubicaciones.find(u => u.id === locationId);
        while(current) {
            path.unshift(current.nombre);
            current = ubicaciones.find(u => u.id === current.parentId);
        }
        return path.join(' / ');
    };

    const populateEquipoCategoriaDropdown = () => {
        const select = document.getElementById('equipo-categoria');
        select.innerHTML = categorias.map(c => `<option value="${c.nombre}">${c.nombre}</option>`).join('');
    };

    const populateEquipoUbicacionDropdown = () => {
        const select = document.getElementById('equipo-ubicacion');
        select.innerHTML = '';
        const buildOptions = (parentId = null, prefix = '') => {
            ubicaciones.filter(u => u.parentId === parentId).forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = prefix + u.nombre;
                select.appendChild(option);
                buildOptions(u.id, prefix + '— ');
            });
        };
        buildOptions();
    };

    const renderEquipos = (filteredEquipos = equipos) => {
        const tableBody = document.getElementById('equipo-table-body');
        tableBody.innerHTML = '';
        filteredEquipos.forEach(e => {
            const statusColors = { 'Operativo': 'bg-green-500', 'En Mantenimiento': 'bg-yellow-500', 'Fuera de Servicio': 'bg-red-500' };
            let actions = '';
            if (['Administrador', 'Supervisor'].includes(currentUser.role)) {
                actions = `<button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editEquipo(${e.id})"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-700" onclick="deleteEquipo(${e.id})"><i class="fas fa-trash"></i></button>`;
            }
            tableBody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-3 font-medium">${e.nombre}</td><td class="p-3 text-gray-600">${e.categoria}</td><td class="p-3 text-gray-600">${getLocationPath(e.ubicacionId)}</td><td class="p-3"><span class="status-dot ${statusColors[e.estado]} mr-2"></span>${e.estado}</td><td class="p-3">${actions}</td></tr>`;
        });
    };
    document.getElementById('search-equipo').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        renderEquipos(equipos.filter(eq => eq.nombre.toLowerCase().includes(searchTerm) || (eq.modelo && eq.modelo.toLowerCase().includes(searchTerm)) || getLocationPath(eq.ubicacionId).toLowerCase().includes(searchTerm)));
    });
    addEquipoBtn.addEventListener('click', () => {
        equipoForm.reset();
        document.getElementById('equipo-id').value = '';
        document.getElementById('equipo-modal-title').textContent = 'Nuevo Equipo';
        populateEquipoCategoriaDropdown();
        populateEquipoUbicacionDropdown();
        openModal(equipoModal);
    });
    window.editEquipo = (id) => {
        const equipo = equipos.find(e => e.id === id);
        if (equipo) {
            populateEquipoCategoriaDropdown();
            populateEquipoUbicacionDropdown();
            document.getElementById('equipo-id').value = equipo.id;
            document.getElementById('equipo-nombre').value = equipo.nombre;
            document.getElementById('equipo-categoria').value = equipo.categoria;
            document.getElementById('equipo-ubicacion').value = equipo.ubicacionId;
            document.getElementById('equipo-modelo').value = equipo.modelo;
            document.getElementById('equipo-serie').value = equipo.serie;
            document.getElementById('equipo-estado').value = equipo.estado;
            document.getElementById('equipo-specs').value = equipo.specs;
            document.getElementById('equipo-modal-title').textContent = 'Editar Equipo';
            openModal(equipoModal);
        }
    };
    window.deleteEquipo = (id) => {
        if (confirm('¿Está seguro?')) {
            equipos = equipos.filter(e => e.id !== id);
            saveData('cmms_equipos', equipos);
            renderEquipos();
        }
    };
    equipoForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('equipo-id').value;
        const equipoData = {
            nombre: document.getElementById('equipo-nombre').value, categoria: document.getElementById('equipo-categoria').value, ubicacionId: parseInt(document.getElementById('equipo-ubicacion').value), modelo: document.getElementById('equipo-modelo').value, serie: document.getElementById('equipo-serie').value, estado: document.getElementById('equipo-estado').value, specs: document.getElementById('equipo-specs').value,
        };
        if (id) {
            const index = equipos.findIndex(e => e.id == id);
            equipos[index] = { ...equipos[index], ...equipoData };
        } else {
            equipoData.id = Date.now();
            equipos.push(equipoData);
        }
        saveData('cmms_equipos', equipos);
        renderEquipos();
        closeModal(equipoModal);
    });

    // --- ÓRDENES DE TRABAJO LOGIC ---
    const getPriorityBadge = (priority) => {
        const colors = { 'Baja': 'bg-gray-100 text-gray-800', 'Media': 'bg-yellow-100 text-yellow-800', 'Alta': 'bg-orange-100 text-orange-800', 'Crítica': 'bg-red-100 text-red-800' };
        return `<span class="priority-badge ${colors[priority]}">${priority}</span>`;
    };
    const getStatusBadge = (status) => {
        const colors = { 'Pendiente': 'bg-blue-500', 'En Progreso': 'bg-yellow-500', 'Completada': 'bg-green-500', 'Cancelada': 'bg-gray-500' };
        return `<span class="status-dot ${colors[status]} mr-2"></span>${status}`;
    };
    const renderOrdenes = (filteredOrdenes = ordenes) => {
        const tableBody = document.getElementById('orden-table-body');
        tableBody.innerHTML = '';
        filteredOrdenes.forEach(o => {
            const equipo = equipos.find(e => e.id === o.equipoId) || { nombre: 'N/A' };
            const tecnico = tecnicos.find(t => t.id === o.tecnicoId) || { nombre: 'N/A' };
            let actions = '';
            if (['Administrador', 'Supervisor', 'Planificador'].includes(currentUser.role)) {
                actions = `<button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editOrden(${o.id})"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-700" onclick="deleteOrden(${o.id})"><i class="fas fa-trash"></i></button>`;
            }
            tableBody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-3 font-medium">OT-${String(o.id).slice(-5)}</td><td class="p-3 text-gray-800">${o.descripcion}</td><td class="p-3 text-gray-600">${equipo.nombre}</td><td class="p-3 text-gray-600">${tecnico.nombre}</td><td class="p-3">${getPriorityBadge(o.prioridad)}</td><td class="p-3">${getStatusBadge(o.estado)}</td><td class="p-3 text-gray-600">${o.fechaCreacion}</td><td class="p-3">${actions}</td></tr>`;
        });
    };
    const applyOrdenFilters = () => {
        const searchTerm = document.getElementById('search-orden').value.toLowerCase();
        const statusFilter = document.getElementById('filter-orden-status').value;
        const priorityFilter = document.getElementById('filter-orden-priority').value;
        const dateFilter = document.getElementById('filter-orden-date').value;
        renderOrdenes(ordenes.filter(o => {
            const equipo = equipos.find(e => e.id === o.equipoId);
            return (o.descripcion.toLowerCase().includes(searchTerm) || (equipo && equipo.nombre.toLowerCase().includes(searchTerm))) && (!statusFilter || o.estado === statusFilter) && (!priorityFilter || o.prioridad === priorityFilter) && (!dateFilter || o.fechaCreacion === dateFilter);
        }));
    };
    ['search-orden', 'filter-orden-status', 'filter-orden-priority', 'filter-orden-date'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', applyOrdenFilters);
        el.addEventListener('change', applyOrdenFilters);
    });
    const populateOrdenModalDropdowns = () => {
        document.getElementById('orden-equipo').innerHTML = equipos.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
        document.getElementById('orden-tecnico').innerHTML = tecnicos.map(t => `<option value="${t.id}">${t.nombre}</option>`).join('');
    };
    addOrdenBtn.addEventListener('click', () => {
        ordenForm.reset();
        document.getElementById('orden-id').value = '';
        document.getElementById('orden-source-solicitud-id').value = '';
        document.getElementById('orden-modal-title').textContent = 'Nueva Orden de Trabajo';
        populateOrdenModalDropdowns();
        openModal(ordenModal);
    });
    window.editOrden = (id) => {
        const orden = ordenes.find(o => o.id === id);
        if (orden) {
            populateOrdenModalDropdowns();
            document.getElementById('orden-id').value = orden.id;
            document.getElementById('orden-descripcion').value = orden.descripcion;
            document.getElementById('orden-equipo').value = orden.equipoId;
            document.getElementById('orden-tecnico').value = orden.tecnicoId;
            document.getElementById('orden-prioridad').value = orden.prioridad;
            document.getElementById('orden-estado').value = orden.estado;
            document.getElementById('orden-detalles').value = orden.detalles;
            document.getElementById('orden-modal-title').textContent = 'Editar Orden de Trabajo';
            openModal(ordenModal);
        }
    };
    window.deleteOrden = (id) => {
        if (confirm('¿Está seguro?')) {
            ordenes = ordenes.filter(o => o.id !== id);
            saveData('cmms_ordenes', ordenes);
            renderOrdenes();
        }
    };
    ordenForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('orden-id').value;
        const solicitudId = document.getElementById('orden-source-solicitud-id').value;
        const ordenData = {
            descripcion: document.getElementById('orden-descripcion').value, equipoId: parseInt(document.getElementById('orden-equipo').value), tecnicoId: parseInt(document.getElementById('orden-tecnico').value), prioridad: document.getElementById('orden-prioridad').value, estado: document.getElementById('orden-estado').value, detalles: document.getElementById('orden-detalles').value,
        };
        if (id) {
            const index = ordenes.findIndex(o => o.id == id);
            ordenes[index] = { ...ordenes[index], ...ordenData };
        } else {
            ordenData.id = Date.now();
            ordenData.fechaCreacion = new Date().toISOString().split('T')[0];
            ordenes.unshift(ordenData);
        }
        if (solicitudId) {
            const index = solicitudes.findIndex(s => s.id == solicitudId);
            if (index !== -1) {
                solicitudes[index].estado = 'Aprobada';
                saveData('cmms_solicitudes', solicitudes);
                renderSolicitudes();
            }
        }
        if (document.getElementById('orden-add-preventivo').checked) {
            const newPreventivo = { id: Date.now(), tarea: `Preventivo: ${ordenData.descripcion}`, equipoId: ordenData.equipoId, frecuencia: 'A definir', proximaFecha: 'N/A', status: 'Programado', tasks: [{id: Date.now(), description: ordenData.descripcion, source: `OT-${ordenData.id.toString().slice(-5)}`}] };
            preventivos.push(newPreventivo);
            saveData('cmms_preventivos', preventivos);
            renderPreventivoTable();
            showNotification('Nueva rutina preventiva creada.', 'info');
        }
        saveData('cmms_ordenes', ordenes);
        renderOrdenes();
        setupDashboard();
        closeModal(ordenModal);
    });

    // --- PREVENTIVO LOGIC (CALENDAR & TABLE) ---
    const renderCalendar = () => {
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearHeader = document.getElementById('month-year-header');
        calendarGrid.innerHTML = '';

        const year = currentDisplayDate.getFullYear();
        const month = currentDisplayDate.getMonth();

        monthYearHeader.textContent = currentDisplayDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            calendarGrid.innerHTML += `<div class="p-2 border border-gray-200 bg-gray-50"></div>`;
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const tasks = scheduledPreventivos.filter(p => p.fecha === dateStr);
            let tasksHtml = '';
            if (tasks.length > 0) {
                tasksHtml = tasks.map(task => `<div class="calendar-task bg-blue-100 text-blue-800">${task.tarea}</div>`).join('');
            }
            const isToday = new Date().toDateString() === new Date(year, month, day).toDateString() ? 'bg-blue-100' : '';
            calendarGrid.innerHTML += `
                <div class="p-2 border border-gray-200 h-24 flex flex-col ${isToday} cursor-pointer hover:bg-gray-100" onclick="showDayDetails('${dateStr}')">
                    <span class="font-semibold">${day}</span>
                    <div class="flex-1 overflow-y-auto">${tasksHtml}</div>
                </div>`;
        }
    };
    
    window.showDayDetails = (dateStr) => {
        const tasks = scheduledPreventivos.filter(p => p.fecha === dateStr);
        const modalTitle = document.getElementById('preventivo-day-modal-title');
        const modalBody = document.getElementById('preventivo-day-modal-body');
        
        modalTitle.textContent = `Tareas para ${new Date(dateStr + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
        
        if (tasks.length === 0) {
            modalBody.innerHTML = '<p class="text-gray-500">No hay tareas programadas para este día.</p>';
        } else {
            modalBody.innerHTML = tasks.map(task => {
                const equipo = equipos.find(e => e.id === task.equipoId);
                return `<div class="p-2 border-b">
                            <p class="font-semibold">${task.tarea}</p>
                            <p class="text-sm text-gray-600">Equipo: ${equipo ? equipo.nombre : 'N/A'}</p>
                        </div>`;
            }).join('');
        }
        openModal(preventivoDayModal);
    };

    document.getElementById('prev-month-btn').addEventListener('click', () => {
        currentDisplayDate.setMonth(currentDisplayDate.getMonth() - 1);
        renderCalendar();
    });

    document.getElementById('next-month-btn').addEventListener('click', () => {
        currentDisplayDate.setMonth(currentDisplayDate.getMonth() + 1);
        renderCalendar();
    });
    
    const renderPreventivoTable = () => {
        const tableBody = document.getElementById('preventivo-table-body');
        tableBody.innerHTML = '';
        preventivos.forEach(p => {
            const equipo = equipos.find(e => e.id === p.equipoId) || { nombre: 'N/A' };
            tableBody.innerHTML += `
                <tr class="border-b hover:bg-gray-50 table-row-clickable" onclick="editPreventivo(${p.id})">
                    <td class="p-3 font-medium">${p.tarea}</td>
                    <td class="p-3 text-gray-600">${equipo.nombre}</td>
                    <td class="p-3 text-gray-600">${p.frecuencia}</td>
                    <td class="p-3 text-gray-600">${p.proximaFecha}</td>
                    <td class="p-3 text-gray-600">${p.status}</td>
                </tr>
            `;
        });
    };

    addPreventivoRutinaBtn.addEventListener('click', () => {
        preventivoRutinaForm.reset();
        document.getElementById('preventivo-rutina-id').value = '';
        document.getElementById('preventivo-rutina-modal-title').textContent = 'Nueva Rutina Preventiva';
        document.getElementById('preventivo-rutina-equipo').innerHTML = equipos.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
        tempPreventivoTasks = [];
        renderPreventivoTasks();
        openModal(preventivoRutinaModal);
    });

    preventivoRutinaForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('preventivo-rutina-id').value;
        const data = {
            tarea: document.getElementById('preventivo-rutina-tarea').value,
            equipoId: parseInt(document.getElementById('preventivo-rutina-equipo').value),
            frecuencia: document.getElementById('preventivo-rutina-frecuencia').value,
            proximaFecha: document.getElementById('preventivo-rutina-fecha').value,
            status: document.getElementById('preventivo-rutina-estado').value,
            tasks: [...tempPreventivoTasks]
        };
        if (id) {
            const index = preventivos.findIndex(p => p.id == id);
            preventivos[index] = { ...preventivos[index], ...data };
        } else {
            data.id = Date.now();
            preventivos.push(data);
        }
        saveData('cmms_preventivos', preventivos);
        renderPreventivoTable();
        closeModal(preventivoRutinaModal);
    });
    
    window.editPreventivo = (id) => {
        const rutina = preventivos.find(p => p.id === id);
        if (rutina) {
            document.getElementById('preventivo-rutina-id').value = rutina.id;
            document.getElementById('preventivo-rutina-modal-title').textContent = 'Editar Rutina Preventiva';
            document.getElementById('preventivo-rutina-tarea').value = rutina.tarea;
            document.getElementById('preventivo-rutina-equipo').innerHTML = equipos.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
            document.getElementById('preventivo-rutina-equipo').value = rutina.equipoId;
            document.getElementById('preventivo-rutina-frecuencia').value = rutina.frecuencia;
            document.getElementById('preventivo-rutina-fecha').value = rutina.proximaFecha;
            document.getElementById('preventivo-rutina-estado').value = rutina.status;
            tempPreventivoTasks = [...(rutina.tasks || [])];
            renderPreventivoTasks();
            openModal(preventivoRutinaModal);
        }
    };

    const renderPreventivoTasks = () => {
        const list = document.getElementById('preventivo-rutina-tasks-list');
        list.innerHTML = '';
        if (tempPreventivoTasks.length === 0) {
            list.innerHTML = `<p class="text-gray-500 text-sm text-center">No hay tareas añadidas.</p>`;
            return;
        }
        tempPreventivoTasks.forEach(task => {
            const sourceText = task.source === 'Manual' ? '' : `<span class="text-xs text-gray-400 ml-2">(${task.source})</span>`;
            list.innerHTML += `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                    <p class="text-sm">${task.description} ${sourceText}</p>
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="deletePreventivoTask(${task.id})">&times;</button>
                </div>
            `;
        });
    };

    document.getElementById('add-task-btn').addEventListener('click', () => {
        const input = document.getElementById('new-task-description');
        if (input.value.trim()) {
            tempPreventivoTasks.push({
                id: Date.now(),
                description: input.value.trim(),
                source: 'Manual'
            });
            input.value = '';
            renderPreventivoTasks();
        }
    });

    window.deletePreventivoTask = (taskId) => {
        tempPreventivoTasks = tempPreventivoTasks.filter(t => t.id !== taskId);
        renderPreventivoTasks();
    };

    document.getElementById('import-ot-btn').addEventListener('click', () => {
        const select = document.getElementById('import-ot-select');
        select.innerHTML = ordenes.map(o => `<option value="${o.id}">OT-${String(o.id).slice(-5)}: ${o.descripcion}</option>`).join('');
        openModal(importOtModal);
    });

    document.getElementById('confirm-import-ot-btn').addEventListener('click', () => {
        const otId = document.getElementById('import-ot-select').value;
        const orden = ordenes.find(o => o.id == otId);
        if (orden) {
            tempPreventivoTasks.push({
                id: Date.now(),
                description: orden.descripcion,
                source: `Importado de OT-${String(orden.id).slice(-5)}`
            });
            renderPreventivoTasks();
            closeModal(importOtModal);
        }
    });


    // --- PERSONAL LOGIC ---
    const renderPersonal = () => {
        const tableBody = document.getElementById('personal-table-body');
        tableBody.innerHTML = '';
        tecnicos.forEach(t => {
            const assignedOrders = ordenes.filter(o => o.tecnicoId === t.id && o.estado !== 'Completada').length;
            tableBody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-3 font-medium">${t.nombre}</td><td class="p-3 text-gray-600">${t.email}</td><td class="p-3 text-gray-600">${t.especialidad}</td><td class="p-3 text-gray-600">${assignedOrders}</td><td class="p-3"><button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editTecnico(${t.id})"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-700" onclick="deleteTecnico(${t.id})"><i class="fas fa-trash"></i></button></td></tr>`;
        });
    };
    addTecnicoBtn.addEventListener('click', () => {
        tecnicoForm.reset();
        document.getElementById('tecnico-id').value = '';
        document.getElementById('tecnico-modal-title').textContent = 'Nuevo Técnico';
        openModal(tecnicoModal);
    });
    tecnicoForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('tecnico-id').value;
        const tecnicoData = { nombre: document.getElementById('tecnico-nombre').value, email: document.getElementById('tecnico-email').value, especialidad: document.getElementById('tecnico-especialidad').value };
        if (id) {
            const index = tecnicos.findIndex(t => t.id == id);
            tecnicos[index] = { ...tecnicos[index], ...tecnicoData };
        } else {
            tecnicoData.id = Date.now();
            tecnicos.push(tecnicoData);
        }
        saveData('cmms_tecnicos', tecnicos);
        renderPersonal();
        closeModal(tecnicoModal);
    });
    window.editTecnico = (id) => {
        const tecnico = tecnicos.find(t => t.id === id);
        if (tecnico) {
            document.getElementById('tecnico-id').value = tecnico.id;
            document.getElementById('tecnico-nombre').value = tecnico.nombre;
            document.getElementById('tecnico-email').value = tecnico.email;
            document.getElementById('tecnico-especialidad').value = tecnico.especialidad;
            document.getElementById('tecnico-modal-title').textContent = 'Editar Técnico';
            openModal(tecnicoModal);
        }
    };
    window.deleteTecnico = (id) => {
        if (confirm('¿Está seguro?')) {
            tecnicos = tecnicos.filter(t => t.id !== id);
            saveData('cmms_tecnicos', tecnicos);
            renderPersonal();
        }
    };

    // --- REPORTES LOGIC ---
    const setupReportes = () => {
        const operationalEquipos = equipos.filter(e => e.estado === 'Operativo').length;
        document.getElementById('report-availability').textContent = `${equipos.length > 0 ? Math.round((operationalEquipos / equipos.length) * 100) : 0}%`;
        const priorityCounts = ordenes.reduce((acc, o) => { acc[o.prioridad] = (acc[o.prioridad] || 0) + 1; return acc; }, {});
        const woPriorityChartCtx = document.getElementById('woPriorityChart').getContext('2d');
        new Chart(woPriorityChartCtx, { type: 'pie', data: { labels: Object.keys(priorityCounts), datasets: [{ data: Object.values(priorityCounts), backgroundColor: ['rgba(107, 114, 128, 0.7)', 'rgba(234, 179, 8, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(239, 68, 68, 0.7)'] }] }, options: { responsive: true } });
    };

    // --- CONFIGURACIÓN LOGIC ---
    const setupConfiguracion = () => {
        const tabs = document.querySelectorAll('#config-tabs .tab-link');
        const tabContents = document.querySelectorAll('#configuracion .tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                tabs.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                const target = document.getElementById(`tab-${tab.dataset.tab}`);
                tabContents.forEach(content => content.classList.remove('active'));
                target.classList.add('active');
            });
        });
    };

    // --- USER MANAGEMENT (CONFIG) LOGIC ---
    const renderUsuarios = () => {
        const tableBody = document.getElementById('usuarios-table-body');
        tableBody.innerHTML = '';
        users.forEach(u => {
            tableBody.innerHTML += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium">${u.username}</td>
                    <td class="p-3 text-gray-600">${u.email}</td>
                    <td class="p-3 text-gray-600">${u.role}</td>
                    <td class="p-3">
                        <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editUsuario(${u.id})"><i class="fas fa-edit"></i></button>
                        <button class="text-red-500 hover:text-red-700" onclick="deleteUsuario(${u.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    };
    
    addUsuarioBtn.addEventListener('click', () => {
        usuarioForm.reset();
        document.getElementById('usuario-id').value = '';
        document.getElementById('usuario-modal-title').textContent = 'Nuevo Usuario';
        document.getElementById('usuario-password').setAttribute('required', true);
        openModal(usuarioModal);
    });

    usuarioForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('usuario-id').value;
        const passwordInput = document.getElementById('usuario-password').value;
        const userData = {
            username: document.getElementById('usuario-username').value,
            email: document.getElementById('usuario-email').value,
            role: document.getElementById('usuario-role').value,
        };

        if (id) {
            const index = users.findIndex(u => u.id == id);
            if (passwordInput) {
                userData.password = passwordInput;
            } else {
                userData.password = users[index].password;
            }
            users[index] = { ...users[index], ...userData };
        } else {
            userData.id = Date.now();
            userData.password = passwordInput;
            users.push(userData);
        }
        saveData('cmms_users', users);
        renderUsuarios();
        closeModal(usuarioModal);
    });

    window.editUsuario = (id) => {
        const user = users.find(u => u.id === id);
        if (user) {
            document.getElementById('usuario-id').value = user.id;
            document.getElementById('usuario-username').value = user.username;
            document.getElementById('usuario-email').value = user.email;
            document.getElementById('usuario-role').value = user.role;
            document.getElementById('usuario-password').value = '';
            document.getElementById('usuario-password').removeAttribute('required');
            document.getElementById('usuario-modal-title').textContent = 'Editar Usuario';
            openModal(usuarioModal);
        }
    };

    window.deleteUsuario = (id) => {
        if (currentUser.id === id) {
            showNotification('No puedes eliminar tu propio usuario.', 'error');
            return;
        }
        if (confirm('¿Está seguro de que desea eliminar este usuario?')) {
            users = users.filter(u => u.id !== id);
            saveData('cmms_users', users);
            renderUsuarios();
        }
    };

    // --- CATEGORIA MANAGEMENT (CONFIG) LOGIC ---
    const renderCategorias = () => {
        const tableBody = document.getElementById('categorias-table-body');
        tableBody.innerHTML = '';
        categorias.forEach(c => {
            tableBody.innerHTML += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium">${c.nombre}</td>
                    <td class="p-3">
                        <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editCategoria(${c.id})"><i class="fas fa-edit"></i></button>
                        <button class="text-red-500 hover:text-red-700" onclick="deleteCategoria(${c.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    };

    addCategoriaBtn.addEventListener('click', () => {
        categoriaForm.reset();
        document.getElementById('categoria-id').value = '';
        document.getElementById('categoria-modal-title').textContent = 'Nueva Categoría';
        openModal(categoriaModal);
    });

    categoriaForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('categoria-id').value;
        const nombre = document.getElementById('categoria-nombre').value;
        if (id) {
            const index = categorias.findIndex(c => c.id == id);
            categorias[index].nombre = nombre;
        } else {
            categorias.push({ id: Date.now(), nombre });
        }
        saveData('cmms_categorias', categorias);
        renderCategorias();
        closeModal(categoriaModal);
    });

    window.editCategoria = (id) => {
        const categoria = categorias.find(c => c.id === id);
        if (categoria) {
            document.getElementById('categoria-id').value = categoria.id;
            document.getElementById('categoria-nombre').value = categoria.nombre;
            document.getElementById('categoria-modal-title').textContent = 'Editar Categoría';
            openModal(categoriaModal);
        }
    };

    window.deleteCategoria = (id) => {
        const categoria = categorias.find(c => c.id === id);
        const isUsed = equipos.some(e => e.categoria === categoria.nombre);
        if (isUsed) {
            showNotification('No se puede eliminar una categoría que está en uso por un equipo.', 'error');
            return;
        }
        if (confirm('¿Está seguro de que desea eliminar esta categoría?')) {
            categorias = categorias.filter(c => c.id !== id);
            saveData('cmms_categorias', categorias);
            renderCategorias();
        }
    };
    
    // --- UBICACION MANAGEMENT (CONFIG) LOGIC ---
    const renderUbicaciones = () => {
        const tableBody = document.getElementById('ubicaciones-table-body');
        tableBody.innerHTML = '';
        const buildRows = (parentId = null, prefix = '') => {
            ubicaciones.filter(u => u.parentId === parentId).forEach(u => {
                tableBody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-medium">${prefix}${u.nombre}</td>
                        <td class="p-3">
                            <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editUbicacion(${u.id})"><i class="fas fa-edit"></i></button>
                            <button class="text-red-500 hover:text-red-700" onclick="deleteUbicacion(${u.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                buildRows(u.id, prefix + '— ');
            });
        };
        buildRows();
    };

    const populateUbicacionPadreDropdown = (currentId = null) => {
        const select = document.getElementById('ubicacion-padre');
        select.innerHTML = '<option value="">Ninguna (Ubicación Principal)</option>';
        const buildOptions = (parentId = null, prefix = '') => {
            ubicaciones.filter(u => u.parentId === parentId && u.id !== currentId).forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = prefix + u.nombre;
                select.appendChild(option);
                buildOptions(u.id, prefix + '— ');
            });
        };
        buildOptions();
    };

    addUbicacionBtn.addEventListener('click', () => {
        ubicacionForm.reset();
        document.getElementById('ubicacion-id').value = '';
        document.getElementById('ubicacion-modal-title').textContent = 'Nueva Ubicación';
        populateUbicacionPadreDropdown();
        openModal(ubicacionModal);
    });

    ubicacionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('ubicacion-id').value;
        const nombre = document.getElementById('ubicacion-nombre').value;
        const parentId = document.getElementById('ubicacion-padre').value ? parseInt(document.getElementById('ubicacion-padre').value) : null;
        if (id) {
            const index = ubicaciones.findIndex(u => u.id == id);
            ubicaciones[index].nombre = nombre;
            ubicaciones[index].parentId = parentId;
        } else {
            ubicaciones.push({ id: Date.now(), nombre, parentId });
        }
        saveData('cmms_ubicaciones', ubicaciones);
        renderUbicaciones();
        closeModal(ubicacionModal);
    });

    window.editUbicacion = (id) => {
        const ubicacion = ubicaciones.find(u => u.id === id);
        if (ubicacion) {
            document.getElementById('ubicacion-id').value = ubicacion.id;
            document.getElementById('ubicacion-nombre').value = ubicacion.nombre;
            populateUbicacionPadreDropdown(id);
            document.getElementById('ubicacion-padre').value = ubicacion.parentId || '';
            document.getElementById('ubicacion-modal-title').textContent = 'Editar Ubicación';
            openModal(ubicacionModal);
        }
    };

    window.deleteUbicacion = (id) => {
        const hasChildren = ubicaciones.some(u => u.parentId === id);
        if (hasChildren) {
            showNotification('No se puede eliminar una ubicación con sub-ubicaciones.', 'error');
            return;
        }
        const isUsed = equipos.some(e => e.ubicacionId === id);
        if (isUsed) {
            showNotification('No se puede eliminar una ubicación asignada a un equipo.', 'error');
            return;
        }
        if (confirm('¿Está seguro de que desea eliminar esta ubicación?')) {
            ubicaciones = ubicaciones.filter(u => u.id !== id);
            saveData('cmms_ubicaciones', ubicaciones);
            renderUbicaciones();
        }
    };

    // --- APP INITIALIZATION ---
    function initializeApp() {
        applyPermissions();
        
        // Setup all modules
        setupDashboard();
        renderSolicitudes();
        renderEquipos();
        renderOrdenes();
        renderPersonal();
        setupReportes();
        setupConfiguracion();
        renderUsuarios();
        renderCategorias();
        renderUbicaciones();
        renderCalendar();
        renderPreventivoTable();

        // Set initial page
        navigateTo(window.location.hash || '#dashboard');
    }

    // --- Initial Check ---
    checkSession();
});
</script>
</body>
</html>
